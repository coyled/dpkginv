#!/usr/bin/env ruby

require 'bundler/setup'
require 'ohai'
require 'json'
require 'open4'
require 'yaml'

Ohai::Config[:plugin_path] << File.dirname(__FILE__) + '/../plugins/ohai'
o = Ohai::System.new

# ohai has dozens of plugins; let's only load the ones we need...
o.require_plugin('linux/lsb')
o.require_plugin('linux/hostname')
o.require_plugin('os')
o.require_plugin('platform')
o.require_plugin('kernel')
o.require_plugin('dpkg')

#
# load system_id from external file,  but it's not required if you
# just want a JSON representation of your packages.  it can be set by
# config management, etc.
#
config_file = '/etc/dpkginv.conf'
if File.exists?(config_file)
    config = YAML.load_file(config_file)
end

json = {
    :fqdn   =>  o[:fqdn],
    :os     =>  {
        :distro     =>  o[:platform],
        :codename   =>  o[:lsb][:codename]
    },
    :kernel =>  {
        :release    =>  o[:kernel][:release],
        :machine    =>  o[:kernel][:machine]
    },
    :dpkg   =>  o[:dpkg]
}

if config['system_id']
    json[:dpkginv_system_id] = config['system_id']
end

puts JSON.pretty_generate(json)
